{% extends "base.html" %}

{% block title %}Home{% endblock %}

{% block head %}
    {{ super() }}
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        /* We must give the map a height, or it will be invisible */
        #map {
            height: 500px;
            border-radius: 12px; /* Nice rounded corners */
            border: 1px solid #ddd;
        }
    </style>
{% endblock %}

{% block content %}
<div class="bg-white p-6 rounded-xl shadow-2xl">
    <h1 class="text-3xl font-bold text-gray-800 text-center mb-4">Field Conditions Dashboard</h1>
    <p id="location-status" class="text-center text-gray-500 mb-6">Trying to find your location...</p>

    <div id="map"></div>

    <div id="weather-container" class="mt-8 text-center hidden">
        <h2 class="text-2xl font-bold text-gray-800">Current Weather</h2>
        <div class="flex items-center justify-center mt-4">
            <img id="weather-icon" src="" alt="Weather icon" class="w-20 h-20">
            <p id="weather-temp" class="text-5xl font-extrabold text-indigo-600 ml-4"></p>
        </div>
        <p id="weather-desc" class="text-xl text-gray-600 mt-2 capitalize"></p>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const statusEl = document.getElementById('location-status');
        const weatherContainer = document.getElementById('weather-container');

        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(showPosition, showError);
        } else {
            statusEl.textContent = "Your browser doesn't support location services.";
        }

        function showPosition(position) {
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;

            // Map logic (from Phase 1)
            const map = L.map('map').setView([lat, lon], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            L.marker([lat, lon]).addTo(map).bindPopup('You are here!').openPopup();

            statusEl.textContent = `Location Found! Fetching weather...`;

            // --- NEW PART FOR PHASE 2 ---
            // Fetch weather from our own server's helper route
            fetch(`/api/weather?lat=${lat}&lon=${lon}`)
                .then(response => response.json())
                .then(data => {
                    statusEl.style.display = 'none'; // Hide the "fetching" message
                    updateWeatherUI(data);
                })
                .catch(error => {
                    console.error('Error fetching weather:', error);
                    statusEl.textContent = 'Could not fetch weather data.';
                });
        }

        // --- NEW FUNCTION TO DISPLAY THE WEATHER ---
        function updateWeatherUI(data) {
            // Un-hide the weather container
            weatherContainer.classList.remove('hidden');

            // Find the HTML elements by their ID and fill them with data
            document.getElementById('weather-temp').textContent = `${data.temperature}Â°C`;
            document.getElementById('weather-desc').textContent = data.description;

            // The icon URL is provided by the weather service
            document.getElementById('weather-icon').src = `https://openweathermap.org/img/wn/${data.icon}@2x.png`;
        }

        function showError(error) {
            statusEl.textContent = "Could not get your location. Please allow location access.";
        }
    });
</script>
{% endblock %}
